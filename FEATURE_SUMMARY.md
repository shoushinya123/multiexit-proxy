# IP健康检查和自动切换功能实现总结

## ✅ 实现的功能

### 1. IP健康检查自动切换
- ✅ 定期检查所有出口IP的健康状态
- ✅ 自动过滤故障IP，只使用健康的IP
- ✅ IP恢复后自动重新启用
- ✅ 无需重启服务，动态生效

### 2. IP自动检测
- ✅ 自动识别服务器绑定的公网IP
- ✅ 支持检测所有网络接口
- ✅ 支持指定网络接口检测
- ✅ 自动合并配置的IP和检测到的IP

## 📁 新增文件

1. **internal/snat/health_aware_selector.go**
   - 健康感知的IP选择器包装器
   - 自动过滤不健康的IP
   - 监听IP状态变化并更新选择器

2. **internal/snat/ip_detector.go**
   - IP自动检测器
   - 支持检测本地绑定IP
   - 支持通过API检测出口IP
   - 支持指定接口检测

3. **internal/snat/ip_detector_test.go**
   - IP检测功能测试

## 🔧 修改的文件

1. **internal/proxy/server.go**
   - 集成健康检查器
   - 使用健康感知的IP选择器
   - 添加健康检查器生命周期管理

2. **cmd/server/main.go**
   - 添加IP自动检测逻辑
   - 启动时自动检测并合并IP列表
   - 集成健康检查配置

3. **internal/config/config.go**
   - 添加健康检查配置结构
   - 添加IP自动检测配置结构
   - 添加配置解析辅助方法

4. **configs/server.yaml.example**
   - 添加健康检查配置示例
   - 添加IP自动检测配置示例

## 📋 配置说明

### 健康检查配置

```yaml
health_check:
  enabled: true      # 启用健康检查
  interval: "30s"    # 检查间隔（默认30秒）
  timeout: "5s"      # 检查超时（默认5秒）
```

### IP自动检测配置

```yaml
ip_detection:
  enabled: true      # 启用IP自动检测
  interface: ""      # 指定网络接口（如"eth0"），为空则检测所有接口
```

## 🔄 工作流程

1. **服务启动时**：
   - 如果启用IP自动检测，自动检测服务器上的公网IP
   - 合并配置的IP和检测到的IP
   - 创建健康检查器
   - 启动后台健康检查任务

2. **健康检查**：
   - 每30秒（可配置）检查一次所有IP
   - 尝试连接IP的80/443/53端口
   - 更新IP健康状态

3. **IP选择时**：
   - 健康感知选择器只从健康的IP中选择
   - 如果没有健康IP，返回错误

4. **IP状态变化**：
   - IP故障：从健康列表移除，重新创建基础选择器
   - IP恢复：添加到健康列表，重新创建基础选择器
   - 整个过程无需重启服务

## 🎯 使用效果

### 之前的问题
- ❌ IP选择器会从所有配置的IP中选择，包括故障IP
- ❌ 无法自动检测服务器上的公网IP
- ❌ IP故障后需要手动重启服务

### 现在的优势
- ✅ 自动过滤故障IP，只使用健康的IP
- ✅ 自动检测服务器上的公网IP，无需手动配置
- ✅ IP故障/恢复自动处理，无需重启
- ✅ 实时监控IP健康状态

## 📊 性能影响

- 健康检查：每30秒检查一次，使用goroutine并发检查，对性能影响极小
- IP选择：健康感知选择器只增加一次map查找，性能影响可忽略
- 动态更新：仅在IP状态变化时触发，频率低，影响小

## ✅ 测试建议

1. 手动停止一个IP，观察是否自动切换到其他IP
2. 恢复IP，观察是否自动重新启用
3. 启用IP自动检测，验证是否正确检测到所有公网IP
4. 查看日志，确认健康检查正常工作

