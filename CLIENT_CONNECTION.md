# 客户端连接服务端说明

## 当前实现

### ✅ 支持的功能

客户端**可以**通过服务端的任意一个公网IP地址连接服务端。

### 工作原理

1. **服务端监听**
   - 服务端监听 `:443`，会绑定到所有网络接口
   - 如果服务端有多个公网IP（如 1.2.3.4, 5.6.7.8），这些IP都会在443端口上监听

2. **客户端连接**
   - 客户端配置中指定服务端地址（可以是域名或IP）
   - 客户端可以使用服务端的任意一个公网IP来连接
   - 例如：`1.2.3.4:443` 或 `5.6.7.8:443`

3. **服务端转发**
   - 服务端接收客户端连接后，根据策略选择一个出口IP
   - 使用选定的出口IP连接到目标服务（SNAT转换）

### 示例配置

假设服务端有3个公网IP：`1.2.3.4`, `5.6.7.8`, `9.10.11.12`

**客户端配置1** - 使用IP1：
```json
{
  "server": {
    "address": "1.2.3.4:443",
    "sni": "cloudflare.com"
  }
}
```

**客户端配置2** - 使用IP2：
```json
{
  "server": {
    "address": "5.6.7.8:443",
    "sni": "cloudflare.com"
  }
}
```

**客户端配置3** - 使用域名（DNS轮询或解析到任一IP）：
```json
{
  "server": {
    "address": "your-server.com:443",
    "sni": "cloudflare.com"
  }
}
```

## 重要概念区分

### 客户端连接IP vs 服务端出口IP

- **客户端连接IP**：客户端用来连接服务端的地址
  - 可以是服务端的任意一个公网IP
  - 客户端连接时使用的IP地址

- **服务端出口IP**：服务端转发到目标服务时使用的IP
  - 由服务端的IP选择策略决定
  - 用于SNAT转换，目标服务看到的源IP

**示例场景**：
```
客户端 -> 1.2.3.4:443 (连接服务端)
服务端接收 -> 根据策略选择出口IP -> 5.6.7.8 (连接到目标服务)
目标服务看到 -> 来源IP: 5.6.7.8
```

## 增强方案（可选）

如果需要更灵活的功能，可以实现：

### 1. 多服务器地址（故障转移）

支持配置多个服务端地址，自动故障转移：

```json
{
  "server": {
    "addresses": [
      "1.2.3.4:443",
      "5.6.7.8:443",
      "9.10.11.12:443"
    ],
    "sni": "cloudflare.com"
  }
}
```

### 2. 自动轮询服务端IP

客户端自动轮询使用不同的服务端IP：

```json
{
  "server": {
    "addresses": [
      "1.2.3.4:443",
      "5.6.7.8:443",
      "9.10.11.12:443"
    ],
    "strategy": "round_robin"
  }
}
```

### 3. 智能选择最快的服务端IP

自动测试延迟，选择最快的服务端IP：

```json
{
  "server": {
    "addresses": [
      "1.2.3.4:443",
      "5.6.7.8:443",
      "9.10.11.12:443"
    ],
    "strategy": "fastest"
  }
}
```

## 使用建议

1. **单个客户端**：直接使用一个服务端IP地址即可
2. **多个客户端**：可以配置不同的客户端使用不同的服务端IP，实现负载均衡
3. **高可用**：如果某个IP不可用，客户端可以切换到其他IP
4. **DNS轮询**：配置域名并设置DNS A记录包含所有IP，DNS会自动轮询

## 总结

✅ **当前实现已支持**：客户端可以通过服务端的任意一个公网IP连接服务端

✅ **灵活性**：客户端连接使用的IP和服务端转发使用的出口IP是独立的

✅ **扩展性**：可以轻松添加多地址、故障转移等功能



