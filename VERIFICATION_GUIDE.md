# 功能验证指南

## 🚀 快速启动

### 方式1: 使用启动脚本（推荐）

```bash
# 1. 给脚本添加执行权限
chmod +x start-dev.sh stop-dev.sh

# 2. 启动服务
./start-dev.sh

# 3. 停止服务
./stop-dev.sh
```

### 方式2: 手动启动

#### 启动后端

```bash
# 1. 编译后端
go build -o server ./cmd/server

# 2. 启动后端服务
./server -config configs/server.yaml
```

后端服务将启动在：
- 代理服务: `:8443` (根据配置文件)
- Web管理界面: `:8080` (根据配置文件)

#### 启动前端

```bash
# 1. 进入前端目录
cd frontend-system-design

# 2. 安装依赖（首次运行）
pnpm install  # 或 npm install

# 3. 启动开发服务器
pnpm dev  # 或 npm run dev
```

前端服务将启动在：`http://localhost:8081`

## 🔧 配置检查

### 后端配置 (configs/server.yaml)

确保以下配置正确：

```yaml
web:
  enabled: true
  listen: ":8080"  # Web管理界面端口
  username: "admin"
  password: "admin123"

exit_ips:
  - "127.0.0.1"  # 测试时可以保留，生产环境需要真实IP
  - "127.0.0.2"

monitor:
  enabled: true  # 启用监控统计
```

### 前端配置

前端默认会连接到 `/api`，如果后端运行在不同端口，需要配置环境变量：

```bash
# 在 frontend-system-design 目录创建 .env.local
echo "NEXT_PUBLIC_API_BASE=http://localhost:8080/api" > frontend-system-design/.env.local
```

## ✅ 功能验证清单

### 1. 登录功能

- [ ] 访问 `http://localhost:8081`
- [ ] 输入用户名: `admin`
- [ ] 输入密码: `admin123`
- [ ] 点击登录
- [ ] 验证成功跳转到仪表板

**预期结果**: 登录成功，跳转到 `/dashboard`

**错误处理测试**:
- [ ] 输入错误密码，显示错误提示
- [ ] 连续5次错误登录，显示429错误（登录保护）

### 2. 仪表板页面

- [ ] 显示系统状态（运行中/版本/连接数）
- [ ] 显示统计信息（总连接数/活跃连接/流量）
- [ ] 显示IP健康状态
- [ ] 显示最近告警
- [ ] 显示热门域名
- [ ] 数据每5秒自动刷新

**预期结果**: 所有卡片显示数据，数据实时更新

### 3. IP管理页面

- [ ] 显示IP列表
- [ ] 显示IP状态（健康/警告/离线）
- [ ] 显示IP统计（连接数/流量/延迟）
- [ ] 点击"添加IP"按钮
- [ ] 输入新IP地址并保存
- [ ] 验证IP已添加到列表
- [ ] 点击删除按钮删除IP
- [ ] 验证IP已从列表移除
- [ ] 点击"刷新状态"按钮
- [ ] 验证数据更新

**预期结果**: IP列表正确显示，添加/删除功能正常

### 4. 配置管理页面

- [ ] 显示当前配置
- [ ] 修改服务器配置（监听地址/TLS证书）
- [ ] 修改认证配置
- [ ] 修改策略配置
- [ ] 修改网络配置（SNAT设置）
- [ ] 修改日志配置
- [ ] 修改高级配置（健康检查/IP检测/监控等）
- [ ] 点击"保存配置"
- [ ] 验证保存成功提示
- [ ] 点击"重置"按钮
- [ ] 验证配置恢复

**预期结果**: 配置正确加载和保存

### 5. 规则引擎页面

- [ ] 显示规则列表
- [ ] 点击"添加规则"
- [ ] 填写规则名称
- [ ] 设置优先级
- [ ] 添加域名匹配条件（如: `*.example.com`）
- [ ] 添加IP匹配条件（如: `192.168.1.0/24`）
- [ ] 添加端口匹配条件（如: `443`）
- [ ] 选择动作（使用IP/阻止/重定向）
- [ ] 设置目标IP（如果动作是"使用IP"）
- [ ] 保存规则
- [ ] 验证规则出现在列表中
- [ ] 点击编辑按钮修改规则
- [ ] 点击删除按钮删除规则
- [ ] 切换规则启用/禁用状态

**预期结果**: 规则CRUD操作正常，支持组合匹配条件

### 6. 统计监控页面

- [ ] 显示实时统计数据
- [ ] 显示连接数趋势图表
- [ ] 显示按IP的详细统计
- [ ] 切换"自动刷新"开关
- [ ] 点击"刷新"按钮
- [ ] 验证数据更新（10秒刷新）

**预期结果**: 统计数据正确显示，图表正常渲染

### 7. 流量分析页面

- [ ] 显示流量趋势图表
- [ ] 显示域名统计数据
- [ ] 显示异常检测数据
- [ ] 切换时间范围（1小时/24小时/7天/30天）
- [ ] 验证数据根据时间范围更新
- [ ] 点击"导出数据"按钮（功能待实现）

**预期结果**: 流量数据正确显示，时间范围切换正常

### 8. 订阅管理页面

- [ ] 显示订阅链接
- [ ] 显示访问令牌
- [ ] 点击"复制"按钮复制链接
- [ ] 点击"显示二维码"按钮
- [ ] 验证二维码显示
- [ ] 点击"生成新Token"按钮（如果后端支持）
- [ ] 点击"刷新"按钮
- [ ] 查看配置预览

**预期结果**: 订阅链接和Token正确显示，二维码正常生成

### 9. 版本回滚页面

- [ ] 显示配置版本列表
- [ ] 显示当前版本标记
- [ ] 点击"查看"按钮查看版本详情
- [ ] 验证版本信息显示（版本号/创建时间/描述/校验和）
- [ ] 选择历史版本点击"回滚"
- [ ] 确认回滚操作
- [ ] 验证回滚成功提示
- [ ] 验证版本列表更新

**预期结果**: 版本列表正确显示，回滚功能正常

### 10. 错误处理测试

- [ ] 断开后端服务，验证前端显示错误提示
- [ ] 恢复后端服务，验证前端自动恢复
- [ ] 测试401错误（认证失败），验证自动跳转登录
- [ ] 测试网络错误，验证错误提示显示

**预期结果**: 所有错误情况都有适当的提示和处理

## 🔍 API端点验证

可以使用curl验证后端API：

```bash
# 1. 测试状态端点（需要Basic Auth）
curl -u admin:admin123 http://localhost:8080/api/status

# 2. 测试统计端点
curl -u admin:admin123 http://localhost:8080/api/stats

# 3. 测试IP列表
curl -u admin:admin123 http://localhost:8080/api/ips

# 4. 测试配置端点
curl -u admin:admin123 http://localhost:8080/api/config

# 5. 测试规则端点
curl -u admin:admin123 http://localhost:8080/api/rules

# 6. 测试流量分析
curl -u admin:admin123 http://localhost:8080/api/traffic

# 7. 测试订阅链接生成
curl -u admin:admin123 http://localhost:8080/api/subscription/link
```

## 🐛 常见问题

### 问题1: 前端无法连接后端

**解决方案**:
1. 检查后端是否启动: `curl http://localhost:8080/api/status`
2. 检查CORS配置（如果需要）
3. 检查前端环境变量 `NEXT_PUBLIC_API_BASE`

### 问题2: 登录失败

**解决方案**:
1. 检查后端配置中的用户名和密码
2. 检查后端日志查看错误信息
3. 验证Basic Auth是否正确

### 问题3: CSRF Token错误

**解决方案**:
1. 检查后端是否正确返回CSRF Token
2. 检查前端是否正确获取和发送CSRF Token
3. 清除浏览器缓存和localStorage

### 问题4: 数据不刷新

**解决方案**:
1. 检查浏览器控制台是否有错误
2. 检查网络请求是否成功
3. 验证刷新间隔设置是否正确

## 📊 性能验证

### 后端性能

```bash
# 查看后端日志
tail -f multiexit-proxy.log

# 查看系统资源使用
top -p $(pgrep -f "server -config")
```

### 前端性能

- 打开浏览器开发者工具
- 查看Network标签，验证请求响应时间
- 查看Console标签，检查是否有错误或警告

## ✅ 验证完成

完成所有验证后，系统应该能够：
- ✅ 正常登录和认证
- ✅ 所有页面正常显示数据
- ✅ 所有CRUD操作正常
- ✅ 实时数据刷新正常
- ✅ 错误处理正常
- ✅ 配置保存和回滚正常

如果所有功能都正常，说明前后端对接成功！🎉

