# 多出口IP代理系统设计文档

## 一、系统架构概述

### 1.1 整体架构
```
客户端 (Client) 
    ↓ (加密隧道)
代理服务端 (Proxy Server) 
    ↓ (SNAT转换)
多出口IP (EIP Pool)
    ↓
目标服务 (Target Service)
```

### 1.2 核心组件
- **客户端**：接收用户请求，建立加密连接，转发流量
- **服务端**：接收客户端连接，管理多个公网IP，实现SNAT转换
- **IP管理模块**：管理多个EIP，实现轮询、按端口、按目标等策略
- **路由模块**：使用iptables和策略路由实现SNAT转换

## 二、技术选型

### 2.1 编程语言
**推荐：Go语言**
- 并发性能优秀（goroutine）
- 网络编程库丰富
- 跨平台编译
- 性能接近C/C++，开发效率高

**备选：Rust**
- 内存安全
- 性能优秀
- 但开发复杂度较高

### 2.2 网络协议设计

#### 2.2.1 传输层协议
**主选：自定义协议 + TLS 1.3**
- 外层：TLS 1.3加密（看起来像正常HTTPS流量）
- 内层：自定义二进制协议（类似Shadowsocks的AEAD加密）
- 流量混淆：模仿HTTPS握手和TLS流量模式

#### 2.2.2 协议栈设计
```
应用层数据
    ↓
自定义加密层 (AEAD: ChaCha20-Poly1305 或 AES-256-GCM)
    ↓
TLS 1.3 加密层
    ↓
TCP传输
```

### 2.3 避免GFW检测的策略

1. **TLS伪装**：使用标准TLS 1.3，流量特征与正常HTTPS一致
2. **SNI伪装**：TLS握手时使用常见域名SNI（如cloudflare.com, google.com）
3. **流量混淆**：添加随机padding，调整包大小分布
4. **端口复用**：服务端监听443端口（标准HTTPS端口）
5. **时间混淆**：随机延迟，模拟正常请求模式

### 2.4 SNAT实现方案

#### 方案A：iptables + iproute2（推荐）
- 使用iptables的SNAT规则
- 使用ip rule和ip route实现策略路由
- 优点：内核级转发，性能最优
- 缺点：需要root权限

#### 方案B：应用层SNAT（不推荐）
- 在用户态修改源IP
- 需要CAP_NET_ADMIN权限
- 性能较差

### 2.5 多IP管理策略

1. **轮询策略（Round Robin）**
   - 按连接数或流量轮询分配IP
   - 实现简单，负载均衡

2. **按端口分配**
   - 特定端口映射到特定IP
   - 如：0-32767 -> IP1, 32768-65535 -> IP2

3. **按目标地址分配**
   - 根据目标IP/域名哈希分配
   - 相同目标使用相同出口IP

4. **按连接数分配**
   - 统计每个IP的连接数
   - 选择连接数最少的IP

## 三、详细设计

### 3.1 客户端架构

```
┌─────────────────┐
│   用户应用      │
│  (SOCKS5/HTTP)  │
└────────┬────────┘
         │
┌────────▼────────┐
│  本地代理监听   │
│  (127.0.0.1)    │
└────────┬────────┘
         │
┌────────▼──────────────────┐
│  协议封装层               │
│  - 自定义加密             │
│  - TLS封装               │
└────────┬──────────────────┘
         │
┌────────▼────────┐
│  连接到服务端   │
└─────────────────┘
```

### 3.2 服务端架构

```
┌─────────────────┐
│  接收客户端连接  │
│  (TLS + 自定义)  │
└────────┬────────┘
         │
┌────────▼────────────┐
│  协议解析层         │
│  - TLS解密         │
│  - 自定义解密      │
└────────┬────────────┘
         │
┌────────▼────────────┐
│  IP选择策略模块     │
│  - 轮询/端口/目标   │
└────────┬────────────┘
         │
┌────────▼────────────┐
│  SNAT转换模块       │
│  - iptables规则    │
│  - 策略路由        │
└────────┬────────────┘
         │
┌────────▼────────┐
│  转发到目标服务    │
└─────────────────┘
```

### 3.3 数据流设计

#### 客户端到服务端
```
1. 建立TLS连接（伪装为HTTPS）
2. 发送加密的控制消息（认证、目标地址）
3. 发送加密的数据流
```

#### 服务端处理
```
1. 接收并解密TLS数据
2. 解析目标地址
3. 根据策略选择出口IP
4. 配置SNAT规则（如果需要）
5. 建立到目标的连接（使用选定的IP）
6. 双向转发数据
```

### 3.4 认证机制

- **预共享密钥（PSK）**：客户端和服务端共享密钥
- **认证流程**：
  1. 客户端使用PSK加密认证信息
  2. 服务端验证并返回会话密钥
  3. 后续通信使用会话密钥

## 四、技术实现细节

### 4.1 加密方案

**主加密**：ChaCha20-Poly1305
- 速度快
- 安全可靠
- 移动端性能好

**备选**：AES-256-GCM
- 硬件加速支持好
- 标准加密算法

### 4.2 协议格式

#### 控制消息格式（20字节）
```
[版本:1字节][命令:1字节][保留:2字节][长度:2字节][数据:14字节][HMAC:4字节]
```

#### 数据消息格式
```
[类型:1字节][流ID:4字节][长度:2字节][加密数据:变长][HMAC:4字节]
```

### 4.3 SNAT规则管理

使用iptables和iproute2：

```bash
# 创建自定义链
iptables -t nat -N PROXY_SNAT

# 为每个IP创建标记
ip rule add fwmark 1 table 100
ip route add default via <gateway> table 100 src <IP1>

# SNAT规则
iptables -t nat -A PROXY_SNAT -m mark --mark 1 -j SNAT --to-source <IP1>
```

## 五、部署方案

### 5.1 服务端部署
- 操作系统：Linux (CentOS/Ubuntu/Debian)
- 依赖：iptables, iproute2
- 权限：root或CAP_NET_ADMIN
- 端口：443（HTTPS标准端口）

### 5.2 客户端部署
- 支持平台：Windows/macOS/Linux/Android/iOS
- 本地监听：SOCKS5代理（127.0.0.1:1080）
- HTTP代理（127.0.0.1:8080）

### 5.3 配置管理
- 服务端配置文件：YAML格式
- 客户端配置文件：JSON格式
- 支持命令行参数和环境变量

## 六、安全考虑

1. **加密强度**：使用256位密钥
2. **前向保密**：支持密钥交换
3. **重放攻击防护**：时间戳+随机数
4. **流量分析防护**：padding和混淆
5. **认证安全**：防止未授权访问

## 七、性能优化

1. **连接复用**：支持连接池
2. **多路复用**：单个连接支持多路数据流
3. **零拷贝**：使用sendfile/splice
4. **并发处理**：goroutine处理每个连接

## 八、监控和日志

1. **连接统计**：每个IP的连接数、流量
2. **性能指标**：延迟、吞吐量
3. **错误日志**：记录异常情况
4. **访问日志**：可选，记录访问记录

## 九、开发计划

### Phase 1: 核心功能
1. 基础通信协议实现
2. TLS加密层
3. 自定义加密层
4. 简单的IP轮询策略

### Phase 2: SNAT实现
1. iptables规则管理
2. 策略路由实现
3. 多IP管理

### Phase 3: 高级功能
1. 多种IP分配策略
2. 负载均衡
3. 健康检查
4. 动态配置

### Phase 4: 优化和测试
1. 性能优化
2. 压力测试
3. 安全审计
4. 文档完善



